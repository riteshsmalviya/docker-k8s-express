pipeline {
    agent any
    
    environment {
        DOCKER_HUB_REPO = 'riteshm03/docker-k8s-express'
        IMAGE_TAG = "${BUILD_NUMBER}"
        CLUSTER_NAME = 'dev'
    }
    
    stages {
        stage('Setup Kind Cluster') {
            steps {
                script {
                    echo 'Setting up Kind cluster...'
                    bat """
                        REM Check if cluster exists
                        kind get clusters | findstr ${CLUSTER_NAME}
                        if %ERRORLEVEL% NEQ 0 (
                            echo Creating Kind cluster: ${CLUSTER_NAME}
                            kind create cluster --name ${CLUSTER_NAME}
                        ) else (
                            echo Kind cluster ${CLUSTER_NAME} already exists - reusing it
                        )
                        
                        REM Ensure kubeconfig is properly set
                        echo Setting up kubeconfig...
                        kind get kubeconfig --name ${CLUSTER_NAME} > temp_kubeconfig
                        set KUBECONFIG=%CD%\\temp_kubeconfig
                        
                        REM Set kubectl context
                        kubectl config use-context kind-${CLUSTER_NAME}
                        
                        REM Verify cluster connectivity
                        echo Testing cluster connectivity...
                        kubectl get nodes
                        if %ERRORLEVEL% NEQ 0 (
                            echo Cluster not accessible, recreating...
                            kind delete cluster --name ${CLUSTER_NAME}
                            kind create cluster --name ${CLUSTER_NAME}
                            kind get kubeconfig --name ${CLUSTER_NAME} > temp_kubeconfig
                            kubectl config use-context kind-${CLUSTER_NAME}
                        )
                        
                        echo Cluster is ready!
                        kubectl get nodes
                        kubectl cluster-info
                    """
                }
            }
        }
        
        stage('Checkout') {
            steps {
                echo 'Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo 'Building Docker image...'
                    bat "docker build -t ${DOCKER_HUB_REPO}:${IMAGE_TAG} ."
                    bat "docker tag ${DOCKER_HUB_REPO}:${IMAGE_TAG} ${DOCKER_HUB_REPO}:latest"
                }
            }
        }
        
        stage('Load Image to Kind') {
            steps {
                script {
                    echo 'Loading image into Kind cluster...'
                    bat "kind load docker-image ${DOCKER_HUB_REPO}:${IMAGE_TAG} --name ${CLUSTER_NAME}"
                    bat "kind load docker-image ${DOCKER_HUB_REPO}:latest --name ${CLUSTER_NAME}"
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo 'Deploying to Kubernetes...'
                    bat """
                        REM Debug: Check current context and connectivity
                        echo === DEBUG INFO ===
                        kubectl config current-context
                        kubectl get nodes
                        kubectl get pods -A
                        echo === END DEBUG ===
                        
                        REM Apply deployment and service
                        kubectl apply -f k8s/deployment.yaml
                        kubectl apply -f k8s/service.yaml
                        
                        REM For development, use recreate strategy to avoid stuck pods
                        echo Scaling down deployment to 0...
                        kubectl scale deployment express-deployment --replicas=0
                        
                        REM Wait for all pods to terminate with manual checking
                        echo Waiting for pods to terminate...
                        set /a count=0
                        :waitloop
                        kubectl get pods -l app=express-app --no-headers 2>nul | findstr . >nul
                        if %ERRORLEVEL% NEQ 0 goto podsgone
                        set /a count+=1
                        if %count% GEQ 30 (
                            echo Force deleting remaining pods...
                            kubectl delete pods -l app=express-app --force --grace-period=0
                            goto podsgone
                        )
                        timeout /t 2 /nobreak > nul
                        goto waitloop
                        :podsgone
                        echo All pods terminated
                        
                        REM Update deployment with new image
                        kubectl set image deployment/express-deployment express=${DOCKER_HUB_REPO}:${IMAGE_TAG} --record
                        
                        REM Scale back up
                        echo Scaling deployment back to 1...
                        kubectl scale deployment express-deployment --replicas=1
                        
                        REM Wait for new pod manually instead of using kubectl wait
                        echo Waiting for new pod to be ready...
                        set /a attempts=0
                        :checkpod
                        set /a attempts+=1
                        kubectl get pods -l app=express-app --no-headers | findstr Running >nul
                        if %ERRORLEVEL% EQU 0 goto podready
                        if %attempts% GEQ 60 (
                            echo Timeout waiting for pod, checking status...
                            kubectl get pods -l app=express-app
                            kubectl describe pods -l app=express-app
                            goto podready
                        )
                        timeout /t 2 /nobreak > nul
                        goto checkpod
                        :podready
                        
                        echo Deployment process completed!
                        kubectl get pods -l app=express-app
                        kubectl get services express-service
                    """
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                script {
                    echo 'Verifying deployment...'
                    bat """
                        REM Always run verification regardless of previous stage status
                        echo === FINAL DEPLOYMENT STATUS ===
                        kubectl get deployment express-deployment -o wide 2>nul || echo Deployment not found
                        kubectl get pods -l app=express-app -o wide 2>nul || echo No pods found
                        kubectl get services express-service 2>nul || echo Service not found
                        
                        REM Check events for any issues
                        echo === RECENT EVENTS ===
                        kubectl get events --sort-by=.metadata.creationTimestamp | findstr express 2>nul || echo No events found
                        
                        REM Test if service is responsive
                        kubectl get pods -l app=express-app --no-headers 2>nul | findstr Running >nul
                        if %ERRORLEVEL% EQU 0 (
                            echo === SUCCESS ===
                            echo Application appears to be running successfully!
                            echo Access methods:
                            echo - NodePort: http://localhost:30080
                            echo - Port Forward: kubectl port-forward service/express-service 3000:3000
                        ) else (
                            echo === ISSUES DETECTED ===
                            echo Application may not be fully ready. Check pod status above.
                        )
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '🎉 Pipeline completed successfully!'
            echo "✅ Kind cluster: ${CLUSTER_NAME} is running"
            echo "✅ Image built: ${DOCKER_HUB_REPO}:${IMAGE_TAG}"
            echo "✅ Deployed to Kubernetes"
            echo "✅ Access your app at: http://localhost:30080"
        }
        failure {
            echo '❌ Pipeline failed!'
            echo "Check logs above for details"
        }
        always {
            script {
                echo 'Cleaning up local images...'
                try {
                    bat "docker rmi ${DOCKER_HUB_REPO}:${IMAGE_TAG} 2>nul"
                } catch (Exception e) {
                    echo "Image cleanup completed (or no image to clean)"
                }
            }
        }
    }
}
