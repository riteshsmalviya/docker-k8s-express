pipeline {
    agent any
    
    environment {
        DOCKER_HUB_REPO = 'riteshm03/docker-k8s-express'
        CLUSTER_NAME = 'dev'
    }
    
    stages {
        stage('Setup Kind Cluster') {
            steps {
                script {
                    echo 'Setting up Kind cluster...'
                    bat """
                        REM Check if cluster exists
                        kind get clusters | findstr ${CLUSTER_NAME}
                        if %ERRORLEVEL% NEQ 0 (
                            echo Creating Kind cluster: ${CLUSTER_NAME}
                            kind create cluster --name ${CLUSTER_NAME}
                        ) else (
                            echo Kind cluster ${CLUSTER_NAME} already exists - reusing it
                        )
                        
                        REM Ensure kubeconfig is properly set
                        echo Setting up kubeconfig...
                        kind get kubeconfig --name ${CLUSTER_NAME} > temp_kubeconfig
                        set KUBECONFIG=%CD%\\temp_kubeconfig
                        
                        REM Set kubectl context
                        kubectl config use-context kind-${CLUSTER_NAME}
                        
                        REM Verify cluster connectivity
                        echo Testing cluster connectivity...
                        kubectl get nodes
                        if %ERRORLEVEL% NEQ 0 (
                            echo Cluster not accessible, recreating...
                            kind delete cluster --name ${CLUSTER_NAME}
                            kind create cluster --name ${CLUSTER_NAME}
                            kind get kubeconfig --name ${CLUSTER_NAME} > temp_kubeconfig
                            kubectl config use-context kind-${CLUSTER_NAME}
                        )
                        
                        echo Cluster is ready!
                        kubectl get nodes
                        kubectl cluster-info
                    """
                }
            }
        }
        
        stage('Checkout') {
            steps {
                echo 'Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Pull and Load Image') {
            steps {
                script {
                    echo 'Pulling latest image from Docker Hub and loading to Kind...'
                    bat """
                        REM Pull the latest image from Docker Hub
                        echo Pulling ${DOCKER_HUB_REPO}:latest from Docker Hub...
                        docker pull ${DOCKER_HUB_REPO}:latest
                        
                        REM Load latest image into Kind cluster
                        echo Loading latest image into Kind cluster...
                        kind load docker-image ${DOCKER_HUB_REPO}:latest --name ${CLUSTER_NAME}
                        
                        REM Verify image is loaded in Kind
                        echo Verifying image in Kind cluster...
                        docker exec dev-control-plane crictl images | findstr docker-k8s-express || echo Image loaded successfully
                    """
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo 'Deploying to Kubernetes...'
                    bat """
                        REM Delete old deployment to avoid image tag conflicts
                        echo Cleaning up old deployment...
                        kubectl delete deployment express-deployment --ignore-not-found=true
                        
                        REM Wait for cleanup
                        timeout /t 5 /nobreak > nul
                        
                        REM Apply fresh deployment and service  
                        echo Applying fresh deployment...
                        kubectl apply -f k8s/deployment.yaml
                        kubectl apply -f k8s/service.yaml
                        
                        REM Wait for deployment to be ready
                        echo Waiting for deployment to be ready...
                        kubectl wait --for=condition=available --timeout=300s deployment/express-deployment
                        
                        echo Deployment completed!
                        kubectl get pods -l app=express-app
                        kubectl get services express-service
                    """
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                script {
                    echo 'Verifying deployment...'
                    bat """
                        REM Always run verification regardless of previous stage status
                        echo === FINAL DEPLOYMENT STATUS ===
                        kubectl get deployment express-deployment -o wide 2>nul || echo Deployment not found
                        kubectl get pods -l app=express-app -o wide 2>nul || echo No pods found
                        kubectl get services express-service 2>nul || echo Service not found
                        
                        REM Check events for any issues
                        echo === RECENT EVENTS ===
                        kubectl get events --sort-by=.metadata.creationTimestamp | findstr express 2>nul || echo No events found
                        
                        REM Test if service is responsive
                        kubectl get pods -l app=express-app --no-headers 2>nul | findstr Running >nul
                        if %ERRORLEVEL% EQU 0 (
                            echo === SUCCESS ===
                            echo Application appears to be running successfully!
                        ) else (
                            echo === ISSUES DETECTED ===
                            echo Application may not be fully ready. Check pod status above.
                        )
                    """
                }
            }
        }
        
        stage('Setup Access') {
            steps {
                script {
                    echo 'Setting up application access...'
                    bat """
                        REM Create a persistent batch script for port forwarding
                        echo @echo off > start-port-forward.bat
                        echo echo Starting port forwarding for express app... >> start-port-forward.bat
                        echo kind get kubeconfig --name dev ^> temp_kubeconfig >> start-port-forward.bat
                        echo set KUBECONFIG=%CD%\\temp_kubeconfig >> start-port-forward.bat
                        echo kubectl config use-context kind-dev >> start-port-forward.bat
                        echo echo Port forwarding started! Access your app at: http://localhost:3000 >> start-port-forward.bat
                        echo echo Press Ctrl+C to stop port forwarding >> start-port-forward.bat
                        echo kubectl port-forward service/express-service 3000:3000 >> start-port-forward.bat
                        
                        REM Create a stop script as well
                        echo @echo off > stop-port-forward.bat
                        echo echo Stopping port forwarding... >> stop-port-forward.bat
                        echo taskkill /F /IM kubectl.exe 2^>nul ^|^| echo No kubectl processes found >> stop-port-forward.bat
                        echo echo Port forwarding stopped. >> stop-port-forward.bat
                        
                        REM Test connection quickly
                        echo Testing application deployment...
                        kubectl get pods -l app=express-app --no-headers | findstr Running >nul
                        if %ERRORLEVEL% EQU 0 (
                            echo === APPLICATION READY ===
                            echo Your application is deployed and ready!
                            echo 
                            echo TO ACCESS YOUR APP:
                            echo 1. Run: start-port-forward.bat
                            echo 2. Open: http://localhost:3000
                            echo 3. To stop: stop-port-forward.bat
                            echo 
                            echo Scripts created in: %CD%
                        ) else (
                            echo WARNING: Application may not be ready yet
                        )
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo 'üéâ Pipeline completed successfully!'
            echo "‚úÖ Kind cluster: ${CLUSTER_NAME} is running"
            echo "‚úÖ Using image: ${DOCKER_HUB_REPO}:latest"
            echo "‚úÖ Deployed to Kubernetes"
            echo "‚úÖ Access scripts created"
            echo ""
            echo "üöÄ TO ACCESS YOUR APP:"
            echo "1Ô∏è‚É£  Run: start-port-forward.bat"
            echo "2Ô∏è‚É£  Open: http://localhost:3000"
            echo "3Ô∏è‚É£  Stop: stop-port-forward.bat"
            echo ""
            echo "üìÅ Scripts location: ${WORKSPACE}"
        }
        failure {
            echo '‚ùå Pipeline failed!'
            echo "Check logs above for details"
        }
        always {
            script {
                echo 'Pipeline cleanup completed'
                // Access scripts remain available for manual use
            }
        }
    }
}
